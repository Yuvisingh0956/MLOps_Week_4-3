---
name: CI - IRIS Pipeline Test

on:
  push:
    branches: ["dev", "main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Setup Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3️⃣ Setup Node.js for CML
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 4️⃣ Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5️⃣ Configure DVC with GCS remote
      - name: Configure DVC with GCS remote
        env:
          GCPKEY: ${{ secrets.GCPKEY }}
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
        run: |
          echo "$GCPKEY" > dvc-sa-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="${PWD}/dvc-sa-key.json"

          # Reconfigure DVC remote
          dvc remote modify gcs-remote credentialpath dvc-sa-key.json || true

          echo "Testing access to bucket..."
          pip install google-cloud-storage
          python - <<PY
import os, sys, subprocess
bucket = os.getenv("BUCKET_NAME")
print(f"Verifying access to: gs://{bucket}")
res = subprocess.run(["gsutil", "ls", f"gs://{bucket}"],
                     stdout=subprocess.PIPE, stderr=subprocess.PIPE)
if res.returncode != 0:
    print("ERROR: Cannot access bucket.")
    print(res.stderr.decode())
    sys.exit(res.returncode)
print(res.stdout.decode())
PY

      # 6️⃣ Pull data & model from DVC
      - name: Pull DVC data and model
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="${PWD}/dvc-sa-key.json"
          dvc pull --force
          ls -R

      # 7️⃣ Run tests with pytest
      - name: Run pytest and generate markdown report
        run: |
          pytest --md report.md --disable-warnings -q
          echo "✅ Pytest completed."

      # 8️⃣ Install and use CML for PR comments
      - name: Install CML
        run: npm install -g @dvcorg/cml

      - name: Post CML report to Pull Request
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Posting test report comment..."
          cml comment create report.md --token "$GITHUB_TOKEN"
