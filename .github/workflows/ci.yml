name: CI - Model Tests

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Node.js (for CML)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore DVC cache (authenticate)
        env:
          GCPKEY: ${{ secrets.GCPKEY }}
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
        run: |
          # write key to file
          echo "$GCPKEY" > dvc-sa-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="${PWD}/dvc-sa-key.json"
          dvc remote modify gcs-remote credentialpath dvc-sa-key.json || true
          # verify access
          pip install google-cloud-storage
          python - <<PY
import os, subprocess, sys
print("Checking GS access")
res = subprocess.run(["gsutil","ls","gs://"+os.environ['BUCKET_NAME']], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
print(res.stdout.decode())
if res.returncode!=0:
    print("WARNING: gsutil failed", res.stderr.decode()); sys.exit(res.returncode)
PY

      - name: Checkout DVC files
        run: |
          dvc pull --force

      - name: Run pytest and generate markdown report
        run: pytest --md report.md

      - name: Install CML
        run: npm install -g @dvcorg/cml

      - name: Post CML report to PR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cml comment create report.md --token "$GITHUB_TOKEN"
