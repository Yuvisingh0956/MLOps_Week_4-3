---
name: CD - Build & Deploy to GKE

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: "iris-api"
  IMAGE_REPO_REGION: ${{ secrets.GCP_REGION }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  ARTIFACT_REPO: ${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install basic tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud project
        run: |
          gcloud config set project $PROJECT_ID
          gcloud config set compute/region $IMAGE_REPO_REGION

      - name: Install gcloud components & kubectl
        run: |
          # install gcloud components for artifact registry & kubectl if not present
          gcloud --version || (curl -sSL https://sdk.cloud.google.com | bash > /dev/null)
          gcloud components install kubectl --quiet || true
          gcloud components install alpha --quiet || true
          gcloud components install beta --quiet || true
          kubectl version --client

      - name: Setup Docker auth to Artifact Registry
        run: |
          # Enable artifact registry docker auth
          gcloud auth configure-docker ${IMAGE_REPO_REGION}-docker.pkg.dev --quiet

      - name: Install DVC
        run: |
          python -m pip install --upgrade pip
          pip install dvc[gcs]
          pip install dvc-gs

      - name: DVC pull (get model)
        env:
          GCPKEY_B64: ${{ secrets.GCPKEY_BASE64_CD }}
        run: |
          echo "$GCPKEY_B64" | base64 --decode > /home/runner/work/_temp/dvc-sa-key.json
          export GOOGLE_APPLICATION_CREDENTIALS="/home/runner/work/_temp/dvc-sa-key.json"
          dvc pull --force
          
      - name: Build and push Docker image to Artifact Registry
        id: build_push
        env:
          TAG: ${{ github.sha }}
          REGION: ${{ secrets.GCP_REGION }}
          REPO: ${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}
          PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/${IMAGE_NAME}:${TAG}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "Building image ${IMAGE_URI}"
          docker build -t ${IMAGE_URI} .
          docker push ${IMAGE_URI}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Replace image placeholder in k8s manifest
        run: |
          IMAGE_URI=${{ steps.build_push.outputs.IMAGE_URI }}
          echo "Using image: $IMAGE_URI"
          mkdir -p k8s-deploy
          sed "s|REPLACE_IMAGE_PLACEHOLDER|${IMAGE_URI}|g" k8s/deployment.yaml > k8s-deploy/deployment.yaml
          cp k8s/service.yaml k8s-deploy/service.yaml
          ls -R k8s-deploy

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s-deploy/deployment.yaml
          kubectl apply -f k8s-deploy/service.yaml
          # wait for rollout
          kubectl rollout status deployment/iris-api --timeout=120s || kubectl rollout status deployment/iris-api

      - name: Get service external IP
        run: |
          echo "Waiting for LoadBalancer external IP (may take a while)..."
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc iris-api-lb -o jsonpath="{.status.loadBalancer.ingress[0].ip}" || true)
            if [ -n "$EXTERNAL_IP" ]; then
              echo "Service external IP: $EXTERNAL_IP"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done
          kubectl get svc iris-api-lb -o wide
